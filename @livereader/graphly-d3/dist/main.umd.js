(function(k,_){typeof exports=="object"&&typeof module<"u"?_(exports,require("d3")):typeof define=="function"&&define.amd?define(["exports","d3"],_):(k=typeof globalThis<"u"?globalThis:k||self,_(k["Graphly D3"]={},k.d3))})(this,function(k,_){"use strict";var Le=Object.defineProperty;var je=(k,_,Z)=>_ in k?Le(k,_,{enumerable:!0,configurable:!0,writable:!0,value:Z}):k[_]=Z;var b=(k,_,Z)=>(je(k,typeof _!="symbol"?_+"":_,Z),Z);function Z(t){if(t&&t.__esModule)return t;const e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(t){for(const n in t)if(n!=="default"){const o=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,o.get?o:{enumerable:!0,get:()=>t[n]})}}return e.default=t,Object.freeze(e)}const S=Z(_);function dt(t,e){if(!document.getElementById("PRERENDER_SVG")){let o=document.createElementNS("http://www.w3.org/2000/svg","svg");o.setAttribute("id","PRERENDER_SVG"),o.setAttribute("pointer-events","none"),o.setAttribute("width","0"),o.setAttribute("height","0"),o.setAttribute("style","opacity: 0; position: absolute; top: 0; left: 0; width: 0; height: 0;"),document.body.appendChild(o)}let n=document.getElementById("PRERENDER_SVG");n.innerHTML=t.html(),e(n.children[0]),n.innerHTML=""}function A(t){let e={x:0,y:0,width:0,height:0};return dt(t,n=>{e=n.getBBox()}),e}function P(t){return S.select(document.createElementNS("http://www.w3.org/2000/svg",t))}function X(t,e){const n=A(t),o=e/Math.max(n.width,n.height),s={x:-n.width*o/2||0,y:-n.height*o/2||0};return t.attr("transform",`translate(${s.x}, ${s.y}) scale(${o||1})`),{scale:o,translate:s}}function ft(t){const e=P("g"),n=P("circle");return n.attr("r",t),n.attr("transform",`translate(${t}, ${t})`),e.append(()=>n.node()),e}function At(t,e,n=0){const o=P("g"),s=P("path");return s.attr("d",`M ${0} ${-(e/2)} L ${t/2-n} ${-(e/2)} A ${n} ${n} 0 0 1 ${t/2} ${-(e/2)+n} L ${t/2} ${e/2-n} A ${n} ${n} 0 0 1 ${t/2-n} ${e/2} L ${-(t/2)+n} ${e/2} A ${n} ${n} 0 0 1 ${-(t/2)} ${e/2-n} L ${-(t/2)} ${-(e/2)+n} A ${n} ${n} 0 0 1 ${-(t/2)+n} ${-(e/2)} Z`),s.attr("transform",`translate(${t/2}, ${e/2})`),o.append(()=>s.node()),o}function zt(t,e,n=0){const o=ft(e);o.select("circle").attr("fill","none"),o.select("circle").attr("stroke","none");const s=P("path"),r=[];for(let i=0;i<t;i++){const a=i/t*2*Math.PI-Math.PI/2,c=Math.cos(a)*e,l=Math.sin(a)*e;r.push({x:c,y:l})}return s.attr("d",Rt(r,n)),s.attr("transform",`translate(${e}, ${e})`),o.append(()=>s.node()),o}function Rt(t,e){const n=[];t=t.slice();for(let o=0;o<t.length;o++){const s=o+1>t.length-1?(o+1)%t.length:o+1,r=o+2>t.length-1?(o+2)%t.length:o+2,i=t[o],a=t[s],c=t[r],l=Math.sqrt(Math.pow(i.x-a.x,2)+Math.pow(i.y-a.y,2)),u=(l-e)/l,h=[((1-u)*i.x+u*a.x).toFixed(1),((1-u)*i.y+u*a.y).toFixed(1)],p=Math.sqrt(Math.pow(a.x-c.x,2)+Math.pow(a.y-c.y,2)),y=e/p,f=[((1-y)*a.x+y*c.x).toFixed(1),((1-y)*a.y+y*c.y).toFixed(1)];o===t.length-1&&n.unshift("M"+f.join(",")),n.push("L"+h.join(",")),n.push("Q"+a.x+","+a.y+","+f.join(","))}return n.push("Z"),n.join(" ")}const Nt=Object.freeze(Object.defineProperty({__proto__:null,prerender:dt,getBBox:A,create:P,transform:X,Circle:ft,Rectangle:At,Polygon:zt},Symbol.toStringTag,{value:"Module"})),Ce="";function O(t,e,n){return{key:t,value:e,condition:n!=null?n:!0}}function Zt(t,e,n,o){return{shape:t,key:e,value:n,condition:o!=null?o:!0}}function Y(t,e){e.forEach(n=>{n.key==="class"&&n.value.split(".").forEach(o=>{t.classed(o,typeof n.condition=="function"?n.condition():n.condition)}),(typeof n.condition=="function"?n.condition():n.condition)&&t.style(n.key,n.value)})}function pt(t,e){e.forEach(n=>{n.key==="class"&&n.value.split(".").forEach(o=>{n.shape.classed(o,typeof n.condition=="function"?n.condition(t):n.condition)}),(typeof n.condition=="function"?n.condition(t):n.condition)&&n.shape.style(n.key,n.value)})}function Ot(t){const e=P("path");return e.attr("d",t),e}function yt(t){const e=P("g");return e.html(t),e}function It(t,e=[],n=[],o=0){let s={top:0,right:0,bottom:0,left:0};return typeof t=="number"?s={top:t,right:t,bottom:t,left:t}:Array.isArray(t)&&t.length===2?s={top:t[0],right:t[1],bottom:t[0],left:t[1]}:Array.isArray(t)&&t.length===4&&(s={top:t[0],right:t[1],bottom:t[2],left:t[3]}),{padding:s,textStyles:e,backgroundStyles:n,cornerRadius:o}}function U(t,e){const n=P("g").classed("tag",!0),o=n.append("text").text(t).attr("dy","0.35em").attr("text-anchor","middle");Y(o,e.textStyles);const s=A(n),r=s.width,i=s.height,a=e.padding.top,c=e.padding.right,l=e.padding.bottom,u=e.padding.left,h=e.cornerRadius,p=n.append("path").attr("d",`M ${0} ${-(i/2)-a} L ${r/2+c-h} ${-(i/2)-a} A ${h} ${h} 0 0 1 ${r/2+c} ${-(i/2)-a+h} L ${r/2+c} ${i/2+l-h} A ${h} ${h} 0 0 1 ${r/2+c-h} ${i/2+l} L ${-(r/2)-u+h} ${i/2+l} A ${h} ${h} 0 0 1 ${-(r/2)-u} ${i/2+l-h} L ${-(r/2)-u} ${-(i/2)-a+h} A ${h} ${h} 0 0 1 ${-(r/2)-u+h} ${-(i/2)-a} Z`);return Y(p,e.backgroundStyles),o.remove(),n.append(()=>o.node()),n}function q(t,e=[]){const n=P("g").classed("text",!0),o=n.append("text").text(t);return Y(o,e),n.attr("text-anchor","middle"),n}function gt(){return"break-line"}var tt=(t=>(t.Left="left",t.Center="center",t.Right="right",t))(tt||{});function et(t,e,n,o,s,r,i,a="center",c=[]){return{height:t,width:e,x:n,y:o,dx:s,dy:r,rowCount:i,align:a,rowMargins:c}}function nt(t,e,n=null){const o=P("g").classed("collection",!0).attr("transform",`translate(${e.x}, ${e.y})`);return Ht(t,e,n,o),o}function Ht(t,e,n=null,o){const s=(e.height-e.dy*(e.rowCount-1))/e.rowCount;let r=0,i=[];for(let a=0;a<e.rowCount;a++){if(r>t.length-1)return;const c=e.rowMargins[a]||0,l=e.width-c*2,u=o.append("g").attr("id",`row-${a}`).attr("transform",`translate(${c}, ${(s+e.dy)*a})`);r=Gt(t,e,n,u,l,r,i,a==e.rowCount-1)}}function Gt(t,e,n=null,o,s,r,i,a){const c=[];let l=0,u=r;for(;l<s&&u<t.length;){const p=t[u];if(!p)break;if(typeof p=="string"){u++;break}if(typeof p=="string")break;const y=A(p).width;if(y>s){i.push(p),u++;continue}if(l+y<s)c.push(p),l+=y+e.dx,u++;else{a&&i.push(p);break}}n&&i.length>0&&(u>=t.length||a)&&(c.push(n),l+=A(n).width+e.dx),l-=e.dx;let h=0;return c.forEach(p=>{const y=A(p).width;let f=0;switch(e.align){case"left":f=h+y/2;break;case"center":f=h+y/2+(s-l)/2;break;case"right":f=h+y/2+(s-l);break}p.attr("transform",`translate(${f}, 0)`),o.append(()=>p.node()),h+=y+e.dx}),u}function ot(t,e,n=[]){const o=[];t.split(" ").forEach(a=>{a.includes(`
`)?(a.split(`
`).forEach(l=>{o.push(q(l,n)),o.push(gt())}),o.pop()):o.push(q(a,n))});const r=q("...",n);return nt(o,e,r)}function Bt(t,e,n){const o=[];t.forEach(i=>{const a=U(i,n);o.push(a)});const s=U("...",n);return nt(o,e,s)}function Wt(t,e,n=[]){const o=`${t.id}-${e}`,s=e/(isNaN(t.shape.scale)?1:t.shape.scale);t.forceSimulation.registerOnZoom(o,s,r=>{if(S.select("[data-id='"+t.id+"']").size()===0)return t.forceSimulation.deregisterOnZoom(o);const i=r*(isNaN(t.shape.scale)?1:t.shape.scale);pt(i,n)})}function Ft(t,e,n,...o){!e.forceSimulation||e.forceSimulation.eventStore.emit(`template:${e.shape.type}:${t}`,e,n,...o)}const st=Object.freeze(Object.defineProperty({__proto__:null,Shape:Nt,ShapeStyle:O,LODStyle:Zt,applyStyles:Y,applyLODStyles:pt,PathShape:Ot,SVGShape:yt,TagStyle:It,TagShape:U,BreakLine:gt,Alignment:tt,CollectionStyle:et,ShapeCollection:nt,TextCollection:ot,TagCollection:Bt,OnZoom:Wt,EmitEvent:Ft},Symbol.toStringTag,{value:"Module"})),Xt={shapeSize:200,shapeBuilder:Yt};function Yt(t){const e=P("g"),{icon_large:n}=Vt(e);return n.classed("hidden",!0),Qt(e),Jt(t,e),e}function Vt(t){const e=yt(`
		<g>
			<path id="border" d="M8.373,392.094c-11.164,-19.338 -11.164,-43.163 0,-62.5c39.417,-68.271 132.833,-230.073 172.249,-298.344c11.165,-19.338 31.798,-31.25 54.127,-31.25l344.498,0c22.329,-0 42.962,11.912 54.126,31.25c39.417,68.271 132.833,230.073 172.249,298.344c11.165,19.337 11.165,43.162 0,62.5c-39.416,68.271 -132.832,230.073 -172.249,298.344c-11.164,19.337 -31.797,31.25 -54.126,31.25l-344.498,-0c-22.329,-0 -42.962,-11.913 -54.127,-31.25c-39.416,-68.271 -132.832,-230.073 -172.249,-298.344Zm41.667,-0c-11.164,-19.338 -11.164,-43.163 0,-62.5c35.831,-62.06 115.585,-200.199 151.416,-262.26c11.164,-19.337 31.797,-31.25 54.126,-31.25l302.831,0c22.33,0 42.963,11.913 54.127,31.25c35.831,62.061 115.585,200.2 151.416,262.26c11.164,19.337 11.164,43.162 -0,62.5c-35.831,62.06 -115.585,200.199 -151.416,262.259c-11.164,19.338 -31.797,31.25 -54.127,31.25l-302.831,0c-22.329,0 -42.962,-11.912 -54.126,-31.25c-35.831,-62.06 -115.585,-200.199 -151.416,-262.259Z" style="fill:#e57373;" />
			<path id="body" d="M50.04,392.094c-11.164,-19.338 -11.164,-43.163 0,-62.5c35.831,-62.06 115.585,-200.199 151.416,-262.26c11.164,-19.337 31.797,-31.25 54.126,-31.25l302.831,0c22.33,0 42.963,11.913 54.127,31.25c35.831,62.061 115.585,200.2 151.416,262.26c11.164,19.337 11.164,43.162 -0,62.5c-35.831,62.06 -115.585,200.199 -151.416,262.259c-11.164,19.338 -31.797,31.25 -54.127,31.25l-302.831,0c-22.329,0 -42.962,-11.912 -54.126,-31.25c-35.831,-62.06 -115.585,-200.199 -151.416,-262.259Z" />
			<path id="icon" d="M392.598,301.417c-0,7.953 6.447,14.4 14.4,14.4c0.003,-0 0.005,-0 0.008,-0c3.817,-0 7.478,-1.516 10.177,-4.215c2.699,-2.699 4.215,-6.36 4.215,-10.177c-0,-1.135 -0,-2.281 -0,-3.416c-0,-3.817 -1.516,-7.478 -4.215,-10.177c-2.699,-2.699 -6.36,-4.215 -10.177,-4.215c-0.003,-0 -0.005,-0 -0.008,-0c-7.953,-0 -14.4,6.447 -14.4,14.4c-0,1.129 -0,2.27 -0,3.4Zm2.242,-47.423c0.2,6.587 5.597,11.823 12.187,11.823c0.003,-0 0.007,-0 0.01,-0c6.556,-0 11.93,-5.202 12.144,-11.755c0.506,-15.54 1.397,-42.915 1.944,-59.729c0.124,-3.806 -1.301,-7.499 -3.949,-10.235c-2.649,-2.736 -6.294,-4.281 -10.102,-4.281c-0.004,-0 -0.008,-0 -0.012,-0c-3.795,-0 -7.429,1.537 -10.072,4.261c-2.643,2.724 -4.07,6.403 -3.955,10.196c0.507,16.785 1.335,44.149 1.805,59.72Z" style="fill:#e57373;fill-rule:nonzero;" />
			<path id="icon_large" d="M371.559,477.859c-0,19.491 15.8,35.291 35.291,35.291c0.002,0 0.004,0 0.005,0c19.491,0 35.292,-15.8 35.292,-35.291c-0,-2.771 -0,-5.568 -0,-8.339c-0,-19.491 -15.801,-35.291 -35.292,-35.291c-0.001,-0 -0.003,-0 -0.005,-0c-19.491,-0 -35.291,15.8 -35.291,35.291c-0,2.771 -0,5.568 -0,8.339Zm5.494,-116.303c0.489,16.181 13.748,29.045 29.936,29.045l0.012,0c16.041,0 29.188,-12.726 29.71,-28.758c1.239,-38.08 3.425,-105.217 4.768,-146.446c0.303,-9.329 -3.19,-18.381 -9.681,-25.088c-6.492,-6.706 -15.426,-10.492 -24.759,-10.492c-0.003,-0 -0.005,-0 -0.007,-0c-9.309,-0 -18.22,3.77 -24.702,10.451c-6.481,6.68 -9.981,15.702 -9.699,25.006c1.243,41.116 3.268,108.114 4.422,146.282Z" style="fill:#e57373;fill-rule:nonzero;" />
		</g>
	`);return t.append(()=>e.node()),t.classed("gly_animated",!0),{border:e.select("#border"),body:e.select("#body"),icon:e.select("#icon"),icon_large:e.select("#icon_large")}}function Qt(t){const e=A(t),n=ot("Template Error",et(100,e.width,0,140,20,20,1),[O("class","gly_text.dark"),O("font-weight","bold"),O("font-size","44pt")]);return t.append(()=>n.node()),n}function Jt(t,e){var s;const n=A(e),o=ot((s=t==null?void 0:t.errorMessage)!=null?s:"Something went wrong while rendering the template!",et(250,n.width,0,n.height*.6,15,20,4,tt.Center,[80,130,180,230]),[O("class","gly_text.dark"),O("font-size","32pt")]);return e.append(()=>o.node()),o}class Kt{constructor(){b(this,"_errorTemplate",Xt);b(this,"_templates",{});b(this,"failed",[]);b(this,"remoteOrigin","")}get errorTemplate(){return this._errorTemplate}get templates(){return this._templates}add(e,n){this._templates[e]=n}async get(e){var s;const n=e.shape.type;return this.templates[n]?this.templates[n]:this.failed.includes(n)?this.errorTemplate:await this.load((s=e.shape.url)!=null?s:this.remoteOrigin+n+".js",n).then(()=>{if(this.templates[n])return this.templates[n]})}async load(e,n){this.failed.includes(n)||origin!=""&&await import(e).then(({default:o})=>{this.add(n,o)}).catch(o=>{console.error(`Template "${n}" not founnd \u2013 Fetched from "${e}"`),console.error(o),this.failed.push(n)}).finally(()=>{})}}class Ut{constructor(){b(this,"nodes",{})}clear(){this.nodes={}}add(e,n){this.nodes[e]=this.storeNode(n)}remove(e){delete this.nodes[e]}hasNode(e){return this.nodes[e]!==void 0}hasTemplateChange(e,n){const o=this.nodes[e];return o===void 0?!1:o.shape.type!==n.shape.type||o.shape.template!==n.shape.template}hasPayloadChanges(e,n){var s,r;const o=this.nodes[e];return o?JSON.stringify((s=o.payload)!=null?s:"")!==JSON.stringify((r=n.payload)!=null?r:""):!0}storeNode(e){return{shape:{type:Object.assign({},e.shape).type,template:Object.assign({},e.shape).template},payload:e.payload?this.deepCopy(e.payload):void 0}}deepCopy(e){if(e==null)return e;if(e instanceof Array){var n=[];return e.forEach(r=>{n.push(r)}),n.map(r=>this.deepCopy(r))}if(e instanceof Object){var o={...e};for(var s in e)e.hasOwnProperty(s)&&(o[s]=this.deepCopy(e[s]));return o}return e}}var I=(t=>(t.Soft="soft",t.Hard="hard",t))(I||{}),M=(t=>(t.Solid="solid",t.Dashed="dashed",t.Dotted="dotted",t.Hidden="hidden",t))(M||{}),H=(t=>(t.Strong="strong",t.Weak="weak",t.Loose="loose",t))(H||{});function mt(t){var h,p,y,f,v;if(!t.forceSimulation)return t.shape.failed=!0,null;const n=t.forceSimulation.nodeDataStore.hasNode(t.id)?S.select(this):P("g"),o=t.forceSimulation.nodeDataStore.hasPayloadChanges(t.id,t),s=t.forceSimulation.nodeDataStore.hasTemplateChange(t.id,t);if(t.forceSimulation.nodeDataStore.add(t.id,t),!o&&!s&&!t.shape.failed)return X(n.select("[data-object=shape]"),t.shape.scale*((p=(h=t.shape.template)==null?void 0:h.shapeSize)!=null?p:300)),n.node();if(n.selectAll("*").remove(),n.classed("gly-node",!0).attr("data-id",t.id),!t.shape.template)return u(`Template "${t.shape.type}" not found!`);try{n.append(()=>t.shape.template.shapeBuilder.bind(this)(t,st).node()).attr("data-object","shape")}catch(d){return console.error(d),u(d.message)}const r=A(n),i=t.shape.scale*((f=(y=t.shape.template)==null?void 0:y.shapeSize)!=null?f:300);t.shape.bodyPoints=[];const a=n.select(".gly-body").node(),c=[];if(a&&a.getTotalLength){let d=((v=t.shape)==null?void 0:v.bodyResolution)||32;const w=a.getTotalLength();for(let g=0;g<d;g++){const D=a.getPointAtLength(g/d*w);D.x=Math.round(D.x),D.y=Math.round(D.y),c.push(D)}const x=Math.min(...c.map(g=>g.x)),E=Math.max(...c.map(g=>g.x)),$=Math.min(...c.map(g=>g.y)),L=Math.max(...c.map(g=>g.y)),j=E-x,C=L-$,T={x:r.width/j,y:r.height/C};c.forEach(g=>{var D,z,R,N,G,B,W,F;g.x=(g.x-x)*T.x+r.x-j*T.x/2+i,g.y=(g.y-$)*T.y+r.y-C*T.y/2+i,((z=(D=t.forceSimulation)==null?void 0:D.debug)==null?void 0:z.enabled)&&((G=(N=(R=t.forceSimulation)==null?void 0:R.debug)==null?void 0:N.bodyPoints)==null?void 0:G.enabled)&&n.select("[data-object=shape]").append("circle").classed("gly-body-points",!0).attr("cx",g.x+j*T.x/2-i).attr("cy",g.y+C*T.y/2-i).attr("r",Math.max(r.height,r.width)/i*5).attr("fill",(F=(W=(B=t.forceSimulation)==null?void 0:B.debug)==null?void 0:W.bodyPoints)==null?void 0:F.color).attr("stroke","none")}),t.shape.bodyPoints=c}t.shape.failed=!1;const l=X(n.select("[data-object=shape]"),i);for(let d of c)d.x=(d.x-i)*l.scale,d.y=(d.y-i)*l.scale;return n.node();function u(d){var w,x,E,$;return t.shape.failed=!0,t.errorMessage=d,n.append(()=>t.forceSimulation?t.forceSimulation.templateStore.errorTemplate.shapeBuilder.bind(this)(t,st).node():null).attr("data-object","shape"),X(n.select("[data-object=shape]"),t.shape.scale*(($=(E=(x=(w=t.forceSimulation)==null?void 0:w.templateStore)==null?void 0:x.errorTemplate)==null?void 0:E.shapeSize)!=null?$:300)),n.node()}}var m=(t=>(t.NodeClick="node:click",t.NodeDoubleClick="node:doubleclick",t.NodeContextMenu="node:contextmenu",t.NodeDragStart="node:dragstart",t.NodeDragMove="node:dragmove",t.NodeDragEnd="node:dragend",t.LinkClick="link:click",t.LinkDoubleClick="link:doubleclick",t.LinkContextMenu="link:contextmenu",t.LinkDragStart="link:dragstart",t.LinkDragMove="link:dragmove",t.LinkDragEnd="link:dragend",t.EnvironmentClick="environment:click",t.EnvironmentDoubleClick="environment:doubleclick",t.EnvironmentContextMenu="environment:contextmenu",t.EnvironmentMove="environment:move",t.SimulationTick="simulation:tick",t.SimulationTickEnd="simulation:tickend",t))(m||{});const qt={["node:click"]:{event:t=>t,node:t=>t},["node:doubleclick"]:{event:t=>t,node:t=>t},["node:contextmenu"]:{event:t=>t,node:t=>t},["node:dragstart"]:{event:t=>t,node:t=>t,pos:(t,e)=>({x:t,y:e})},["node:dragmove"]:{event:t=>t,node:t=>t,pos:(t,e)=>({x:t,y:e})},["node:dragend"]:{event:t=>t,node:t=>t,pos:(t,e)=>({x:t,y:e})},["link:click"]:{event:t=>t,link:t=>t},["link:doubleclick"]:{event:t=>t,link:t=>t},["link:contextmenu"]:{event:t=>t,link:t=>t},["link:dragstart"]:{event:t=>t,source:t=>t,pos:(t,e)=>({x:t,y:e})},["link:dragmove"]:{event:t=>t,source:t=>t,pos:(t,e)=>({x:t,y:e})},["link:dragend"]:{event:t=>t,source:t=>t,target:t=>t,pos:(t,e)=>({x:t,y:e})},["environment:click"]:{event:t=>t,pos:(t,e)=>({x:t,y:e})},["environment:doubleclick"]:{event:t=>t,pos:(t,e)=>({x:t,y:e})},["environment:contextmenu"]:{event:t=>t,pos:(t,e)=>({x:t,y:e})},["environment:move"]:{pos:t=>t},["simulation:tick"]:{},["simulation:tickend"]:{}};class xt{constructor(){b(this,"register",{})}on(e,n){this.register[e]||(this.register[e]={}),this.register[e][n.name]=n}off(e,n){!this.register[e]||delete this.register[e][n.name]}emit(e,...n){if(!!this.register[e])for(const o in this.register[e])return this.register[e][o](...n)}}b(xt,"events",qt);let V=!1,Q,rt={x:0,y:0};function te(){return S.drag().on("start",(t,e)=>ee.bind(this)(t,e)).on("drag",(t,e)=>ne.bind(this)(t,e)).on("end",(t,e)=>oe.bind(this)(t,e))}function ee(t,e){if(this.eventStore.emit(m.NodeDragStart,t,e,{x:t.x,y:t.y})=="newlink")return se.bind(this)(t,e);!this.draggableNodes||(this.simulation.alphaTarget(.05).restart(),e.isDraged=!0,e.fx=t.x,e.fy=t.y)}function ne(t,e){if(V)return re.bind(this)(t,e);!this.draggableNodes||(e.fx=t.x,e.fy=t.y,this.eventStore.emit(m.NodeDragMove,t,e,{x:t.x,y:t.y}))}function oe(t,e){if(V)return bt.bind(this)(t,e);if(!this.draggableNodes)return bt.bind(this)(t,e);!this.draggableNodes||(this.simulation.alphaTarget(0),e.isDraged=!1,e.fx=null,e.fy=null,this.eventStore.emit(m.NodeDragEnd,t,e,{x:t.x,y:t.y}))}function se(t,e){var n,o,s,r;rt={x:t.sourceEvent.offsetX/this.worldTransform.k-this.worldTransform.x/this.worldTransform.k-((n=e.x)!=null?n:0),y:t.sourceEvent.offsetY/this.worldTransform.k-this.worldTransform.y/this.worldTransform.k-((o=e.y)!=null?o:0)},V=!0,Q=this.selectionGroups.links.append("g").attr("data-object","prelink").classed("gly-prelink",!0),Q.append("line").attr("data-object","prelink-link-line").classed("gly-link-line",!0).attr("x1",(s=e.x)!=null?s:0).attr("y1",(r=e.y)!=null?r:0).attr("x2",t.x).attr("y2",t.y),this.eventStore.emit(m.LinkDragStart,t,e,{x:t.x,y:t.y})}function re(t,e){const n={x:t.x+rt.x,y:t.y+rt.y};Q.select("[data-object='prelink-link-line']").attr("x2",n.x).attr("y2",n.y),this.eventStore.emit(m.LinkDragMove,t,e,{x:t.x,y:t.y})}function bt(t,e){Q.remove(),V=!1;let n=t.sourceEvent.target;if(n==this.svgElement)return this.eventStore.emit(m.LinkDragEnd,t,e,null,{x:t.x,y:t.y});for(;n.attributes["data-object"]==null;){if(n==null)return this.eventStore.emit(m.LinkDragEnd,t,e,null,{x:t.x,y:t.y});if(n=n.parentElement,!n)return this.eventStore.emit(m.LinkDragEnd,t,e,null,{x:t.x,y:t.y})}if(n=n.parentElement,!n)return this.eventStore.emit(m.LinkDragEnd,t,e,null,{x:t.x,y:t.y});const o=this.graph.nodes.find(s=>{var r;return s.id==((r=n.attributes["data-id"])==null?void 0:r.value)});if(!o)return this.eventStore.emit(m.LinkDragEnd,t,e,null,{x:t.x,y:t.y});if(o.id==e.id)return this.eventStore.emit(m.LinkDragEnd,t,e,null,{x:t.x,y:t.y});this.eventStore.emit(m.LinkDragEnd,t,e,o,{x:t.x,y:t.y})}function ie(t){t.links=t.links.filter(e=>{const n=typeof e.source=="string"?t.nodes.find(s=>s.id===e.source):t.nodes.find(s=>s.id===e.source.id),o=typeof e.target=="string"?t.nodes.find(s=>s.id===e.target):t.nodes.find(s=>s.id===e.target.id);return!(!n||!o)}),t.nodes.forEach(e=>{const n=[];t.links.forEach(s=>{(s.source==e.id||s.source.id==e.id)&&n.push(s)});const o={};n.forEach(s=>{if(typeof s.target=="object"){const r=typeof s.target=="string"?s.target:s.target.id;o[r]||(o[r]=[]),o[r].push(s)}else o[s.target]||(o[s.target]=[]),o[s.target].push(s)}),Object.keys(o).forEach(s=>{o[s].forEach((r,i)=>{r.i=i}),o[s].sort((r,i)=>{var a,c;return((a=r.index)!=null?a:0)-((c=i.index)!=null?c:0)})})})}async function ae(t){await le.bind(this)(t),t.nodes.forEach(n=>{n.forceSimulation=this}),he(t.nodes);const e=this.selectionGroups.nodes.selectAll("[data-object='node']").data(t.nodes,n=>n.id);e.enter().append(mt.bind(this)).attr("data-object","node").style("pointer-events","fill").call(te.bind(this)()).on("click",(n,o)=>{this.eventStore.emit(m.NodeClick,n,o),n.stopPropagation()}).on("dblclick",(n,o)=>{this.eventStore.emit(m.NodeDoubleClick,n,o),n.stopPropagation()}).on("contextmenu",(n,o)=>{this.eventStore.emit(m.NodeContextMenu,n,o),n.stopPropagation()}).attr("opacity",0).transition().duration(this.animationDuration).attr("opacity",1),e.exit().transition().duration(this.animationDuration).attr("opacity",0).each(n=>{this.nodeDataStore.remove(n.id)}).remove(),e.each(n=>{e.filter(s=>s.id===n.id).select(mt)}).attr("opacity",1)}function ce(t){const e=this.selectionGroups.links.selectAll("[data-object='link']").data(t.links,o=>it(o)),n=e.enter().append("g").attr("data-object","link").attr("data-id",o=>it(o)).classed("gly-link",!0).on("click",(o,s)=>{this.eventStore.emit(m.LinkClick,o,s),o.stopPropagation()}).on("dblclick",(o,s)=>{this.eventStore.emit(m.LinkDoubleClick,o,s),o.stopPropagation()}).on("contextmenu",(o,s)=>{this.eventStore.emit(m.LinkContextMenu,o,s),o.stopPropagation()});n.append("path").attr("data-object","link-line-full").attr("fill","none").attr("stroke","none"),n.append("path").attr("data-object","link-line").classed("gly-link-line",!0).classed("solid",o=>o.type?o.type===M.Solid:!0).classed("dashed",o=>o.type===M.Dashed).classed("dotted",o=>o.type===M.Dotted).classed("hidden",o=>o.type===M.Hidden).style("stroke-width",o=>{var s;return(s=o.width)!=null?s:null}),n.append("path").attr("data-object","link-arrow-head").classed("gly-link-arrow",!0).classed("gly-link-arrow-head",!0).classed("hidden",o=>o.type===M.Hidden).style("stroke-width",o=>{var s;return(s=o.width)!=null?s:null}),n.append("path").attr("data-object","link-arrow-tail").classed("gly-link-arrow",!0).classed("gly-link-arrow-tail",!0).classed("hidden",o=>o.type===M.Hidden).style("stroke-width",o=>{var s;return(s=o.width)!=null?s:null}),n.append("text").attr("data-object","link-label").classed("gly-link-label",!0).text(o=>{var s;return o.type!==M.Hidden&&(s=o.label)!=null?s:""}).attr("text-anchor","middle").attr("dominant-baseline","central").attr("dy","0.35em"),n.attr("opacity",0).transition().duration(this.animationDuration).attr("opacity",1),e.exit().transition().duration(this.animationDuration).attr("opacity",0).remove(),e.attr("opacity",1),e.select("[data-object='link-line']").classed("solid",o=>o.type?o.type===M.Solid:!0).classed("dashed",o=>o.type===M.Dashed).classed("dotted",o=>o.type===M.Dotted).classed("hidden",o=>o.type===M.Hidden).style("stroke-width",o=>{var s;return(s=o.width)!=null?s:null}),e.select("[data-object='link-arrow-head']").classed("hidden",o=>o.type===M.Hidden).style("stroke-width",o=>{var s;return(s=o.width)!=null?s:null}),e.select("[data-object='link-arrow-tail']").classed("hidden",o=>o.type===M.Hidden).style("stroke-width",o=>{var s;return(s=o.width)!=null?s:null}),e.select("[data-object='link-label']").text(o=>{var s;return o.type!==M.Hidden&&(s=o.label)!=null?s:""})}async function le(t){for(let e in t.nodes){const n=t.nodes[e];await this.templateStore.get(n).then(o=>{n.shape.template=o})}}function he(t){var e,n,o,s,r,i,a,c,l,u,h,p;for(let y in t){const f=t[y];if(!(f.x||f.y)&&!(f.fx||f.fy)&&!(((e=f.anchor)==null?void 0:e.x)||((n=f.anchor)==null?void 0:n.y))&&!(((o=f.satellite)==null?void 0:o.x)||((s=f.satellite)==null?void 0:s.y))&&f.spawn){const v=typeof f.spawn.source=="string"?f.spawn.source:f.spawn.source.id,d=t.find(L=>L.id===v),w={x:(c=(a=(r=d==null?void 0:d.x)!=null?r:d==null?void 0:d.fx)!=null?a:(i=d==null?void 0:d.anchor)==null?void 0:i.x)!=null?c:0,y:(p=(h=(l=d==null?void 0:d.y)!=null?l:d==null?void 0:d.fy)!=null?h:(u=d==null?void 0:d.anchor)==null?void 0:u.y)!=null?p:0},x=f.spawn.distance,E=f.spawn.angle,$={x:w.x+x*Math.cos(E*Math.PI/180-Math.PI/2),y:w.y+x*Math.sin(E*Math.PI/180-Math.PI/2)};f.x=$.x,f.y=$.y}}}function it(t){return t.id||(t.id=Math.random().toString(36).substring(2,34)+Math.random().toString(36).substring(2,34)),t.id?t.id:(typeof t.source=="string"?t.source:t.source.id)+(typeof t.target=="string"?t.target:t.target.id)+t.type+t.directed+t.label+t.strength}var at=(t=>(t.Head="head",t.Tail="tail",t))(at||{});function ue(t){const e=vt(t),n=wt(t),o=ct(e,n,lt(t,e,n,.1)),s={start:e,center:o,end:n};if(!!s)return`M ${s.start.x} ${s.start.y}Q ${s.center.x}, ${s.center.y} ${s.end.x} ${s.end.y}`}function de(t){var n;const e=ht(t,(n=t.padding)!=null?n:10);if(!!e)return`M ${e.start.x} ${e.start.y}Q ${e.center.x}, ${e.center.y} ${e.end.x} ${e.end.y}`}function St(t,e="head"){var c;if(!t.directed)return"";const n=ht(t,(c=t.padding)!=null?c:10);if(!n)return;const o=Math.atan2(n.end.y-n.center.y,n.end.x-n.center.x),s=10,r={x:n.end.x+s*Math.cos(o+Math.PI/2),y:n.end.y+s*Math.sin(o+Math.PI/2)},i={x:n.end.x+s*Math.cos(o),y:n.end.y+s*Math.sin(o)},a={x:n.end.x+s*Math.cos(o-Math.PI/2),y:n.end.y+s*Math.sin(o-Math.PI/2)};return`M ${r.x} ${r.y}L ${i.x} ${i.y}L ${a.x} ${a.y}`}function fe(t){var r;const e=ht(t,(r=t.padding)!=null?r:10);if(!e)return;const n=kt(e.start,e.end),o=e.center.x+(n.x-e.center.x)/2,s=e.center.y+(n.y-e.center.y)/2;return"translate("+o+","+s+")"}function vt(t){return typeof t.source=="string"||typeof t.target=="string"?{x:0,y:0}:$t(t.target,t.source)}function wt(t){return typeof t.source=="string"||typeof t.target=="string"?{x:0,y:0}:$t(t.source,t.target)}function kt(t,e){return{x:(t.x+e.x)/2,y:(t.y+e.y)/2}}function ct(t,e,n){var s,r;const o=kt(t,e);return{x:o.x+((s=n==null?void 0:n.x)!=null?s:0),y:o.y-((r=n==null?void 0:n.y)!=null?r:0)}}function lt(t,e,n,o){var h;const s=pe(e,n),r=ye(e,n),i=ge(s,r),a=t.curvature||o,c=t.curvature?1:((h=t.i)!=null?h:0)+1,l=a*(r/i)*i*c,u=a*(s/i)*i*c;return{x:l,y:u}}function pe(t,e){return e.x-t.x}function ye(t,e){return e.y-t.y}function ge(t,e){return Math.sqrt(t*t+e*e)}function $t(t,e){var r,i,a,c,l,u,h,p;const n=((r=e.x)!=null?r:0)-((i=t.x)!=null?i:0),o=((a=e.y)!=null?a:0)-((c=t.y)!=null?c:0);return Math.sqrt(n*n+o*o)===0?{x:(l=t.x)!=null?l:0,y:(u=t.y)!=null?u:0}:{x:n+((h=t.x)!=null?h:0),y:o+((p=t.y)!=null?p:0)}}function ht(t,e=0){var x,E,$,L,j,C,T,g,D,z,R,N;const n=vt(t),o=wt(t),s=lt(t,n,o,.1);if(typeof t.source=="string"||typeof t.target=="string")return{start:n,end:o,center:s};const r=ct({x:(x=t.source.x)!=null?x:0,y:(E=t.source.y)!=null?E:0},{x:($=t.target.x)!=null?$:0,y:(L=t.target.y)!=null?L:0},s),i=t.directed?20:0,a=P("g").append("path").attr("d",`M ${n.x} ${n.y}Q ${r.x}, ${r.y} ${o.x} ${o.y}`).node();if(!a)return{start:n,end:o,center:s};const c=t.source.shape.failed?(j=t.source.forceSimulation)==null?void 0:j.templateStore.errorTemplate.shapeSize:(T=(C=t.source.shape.template)==null?void 0:C.shapeSize)!=null?T:300,l=t.target.shape.failed?(g=t.target.forceSimulation)==null?void 0:g.templateStore.errorTemplate.shapeSize:(z=(D=t.target.shape.template)==null?void 0:D.shapeSize)!=null?z:300,u=Mt(t.source,t.target,t,!1),h=Mt(t.source,t.target,t,!0),p=u||((R=t.source.shape.scale)!=null?R:1)*((c!=null?c:300)/2),y=h||((N=t.target.shape.scale)!=null?N:1)*((l!=null?l:300)/2),f=a.getAttribute("d").includes("NaN")?0:a.getPointAtLength(p+e),v=a.getAttribute("d").includes("NaN")?0:a.getPointAtLength(a.getTotalLength()-y-e-i),d=lt(t,f,v,.1),w=ct(f,v,d);return{start:{x:f.x,y:f.y},center:{x:w.x,y:w.y},end:{x:v.x,y:v.y}}}function Mt(t,e,n,o=!1){var f,v,d,w,x,E,$,L,j,C,T,g,D,z,R,N,G,B,W,F,jt,Ct;const s=S.select("[data-id='"+it(n)+"']").select("[data-object='link-line-full']").node();if(!s||!s.getPointAtLength||s.getAttribute("d").includes("NaN"))return 0;const r=o?(f=e.shape.bodyPoints)!=null?f:[]:(v=t.shape.bodyPoints)!=null?v:[];if(r.length===0)return 0;const i=s.getTotalLength(),a=o?-(((w=(d=e.shape.template)==null?void 0:d.shapeSize)!=null?w:300)*((x=e.shape.scale)!=null?x:1))/20:(($=(E=t.shape.template)==null?void 0:E.shapeSize)!=null?$:300)*((L=t.shape.scale)!=null?L:1)/20;let c=o?i:0,l=s.getPointAtLength(c),u={x:0,y:0};o?u={x:l.x-((T=e.x)!=null?T:0),y:l.y-((g=e.y)!=null?g:0)}:u={x:l.x-((j=t.x)!=null?j:0),y:l.y-((C=t.y)!=null?C:0)};let h=0;for(;ut(u,r)&&c<=i&&h<30;)h++,c+=a,l=s.getPointAtLength(c),o?u={x:l.x-((R=e.x)!=null?R:0),y:l.y-((N=e.y)!=null?N:0)}:u={x:l.x-((D=t.x)!=null?D:0),y:l.y-((z=t.y)!=null?z:0)};for(h=0;!ut(u,r)&&c>=0&&h<30;)h++,c=o?c+1:c-1,l=s.getPointAtLength(c),o?u={x:l.x-((W=e.x)!=null?W:0),y:l.y-((F=e.y)!=null?F:0)}:u={x:l.x-((G=t.x)!=null?G:0),y:l.y-((B=t.y)!=null?B:0)};const p=o?((jt=e.shape.scale)!=null?jt:1)/((Ct=t.shape.scale)!=null?Ct:1):1;return(o?i-c:c)*p}function ut(t,e){for(var n=!1,o=0,s=e.length-1;o<e.length;s=o++){var r=e[o].x,i=e[o].y,a=e[s].x,c=e[s].y,l=i>t.y!=c>t.y&&t.x<(a-r)*(t.y-i)/(c-i)+r;l&&(n=!n)}return n}function Et(t){return S.forceLink().id(n=>n.id).strength(n=>{if(n.strength===void 0)return .3;if(typeof n.strength=="number")return n.strength;switch(n.strength){case H.Strong:return .5;case H.Weak:return .3;case H.Loose:return 0;default:return .3}}).distance(t)}function me(){return S.forceX().x(e=>J(e).x).strength(e=>K(e))}function xe(){return S.forceY().y(e=>J(e).y).strength(e=>K(e))}function Tt(t){return S.forceManyBody().strength(n=>n.gravity?n.gravity:t)}function J(t){var e,n,o,s;return t.satellite?{x:(e=t.satellite.x)!=null?e:0,y:(n=t.satellite.y)!=null?n:0}:t.anchor?{x:(o=t.anchor.x)!=null?o:0,y:(s=t.anchor.y)!=null?s:0}:{x:0,y:0}}function K(t){if(t.satellite)return 6;if(t.anchor)switch(t.anchor.type){case I.Hard:case I.Soft:return 2;default:return 0}return 0}function be(t){const e=this.graph.nodes;var n=S.quadtree().x(o=>o.x).y(o=>o.y).addAll(e);e.forEach(o=>{var l,u;o.x=o.x||0,o.y=o.y||0;var s=((u=(l=o.shape.template)==null?void 0:l.shapeSize)!=null?u:300)*o.shape.scale,r=o.x-s,i=o.x+s,a=o.y-s,c=o.y+s;n.visit((h,p,y,f,v)=>{var E,$,L,j,C,T;if(h.data&&h.data!==o){var d=((E=o.x)!=null?E:0)-h.data.x,w=(($=o.y)!=null?$:0)-h.data.y,x=Math.sqrt(d*d+w*w);const g=((j=(L=o.shape.template)==null?void 0:L.shapeSize)!=null?j:300)*o.shape.scale;Se(o,h.data)&&(((C=o.shape.bodyPoints)==null?void 0:C.length)==0||((T=h.data.shape.bodyPoints)==null?void 0:T.length)==0?x<g&&(x=(x-g)/x*t,o.x=o.x||0,o.y=o.y||0,o.x-=d*=x,o.y-=w*=x,h.data.x+=d,h.data.y+=w):ve(o,h.data)&&(x=(x-g)/x*t,o.x=o.x||0,o.y=o.y||0,o.x-=d*=x,o.y-=w*=x,h.data.x+=d,h.data.y+=w))}return p>i||f<r||y>c||v<a})})}function Se(t,e){var a,c,l,u,h,p,y,f,v,d;const n={x:(a=t.x)!=null?a:0,y:(c=t.y)!=null?c:0},o=((h=(u=(l=t.shape)==null?void 0:l.template)==null?void 0:u.shapeSize)!=null?h:300)/2*(t.shape.scale*1.5),s={x:(p=e.x)!=null?p:0,y:(y=e.y)!=null?y:0},r=((d=(v=(f=e.shape)==null?void 0:f.template)==null?void 0:v.shapeSize)!=null?d:300)/2*(e.shape.scale*1.5);return Math.sqrt(Math.pow(n.x-s.x,2)+Math.pow(n.y-s.y,2))<o+r}function ve(t,e){var s,r;const n=((s=t.shape.bodyPoints)!=null?s:[]).map(i=>{var a,c;return{x:i.x-((a=t.x)!=null?a:0),y:i.y-((c=t.y)!=null?c:0)}}),o=((r=e.shape.bodyPoints)!=null?r:[]).map(i=>{var a,c;return{x:i.x-((a=e.x)!=null?a:0),y:i.y-((c=e.y)!=null?c:0)}});for(let i=0;i<n.length;i++){const a={x:n[i].x,y:n[i].y};if(ut(a,o))return!0}return!1}function we(){for(let t in this.graph.nodes)this.graph.nodes[t].isDraged||(ke(this.graph,this.graph.nodes[t]),$e(this.graph.nodes[t]));this.selectionGroups.nodes.selectAll("[data-object='node']").attr("transform",t=>{var e,n;return`translate(${(e=t.x)!=null?e:0},${(n=t.y)!=null?n:0})`}),this.selectionGroups.links.selectAll("[data-object='link']").call(t=>{t.select("[data-object='link-line-full']").attr("d",ue),t.select("[data-object='link-line']").attr("d",de),t.select("[data-object='link-arrow-head']").attr("d",i=>St(i,at.Head)),t.select("[data-object='link-arrow-tail']").attr("d",i=>St(i,at.Tail)),t.select("[data-object='link-label']").attr("transform",fe)}),this.simulation.force("forceX").x(t=>J(t).x).strength(t=>K(t)),this.simulation.force("forceY").y(t=>J(t).y).strength(t=>K(t)),this.eventStore.emit(m.SimulationTick)}function ke(t,e){var r,i,a,c,l,u,h,p;if(!e.satellite)return;if(typeof e.satellite.source=="string"){const y=t.nodes.find(f=>f.id===e.satellite.source);if(!y)return;e.satellite.source=y}const n=(r=e.satellite.distance)!=null?r:400,o=(i=e.satellite.angle)!=null?i:0,s={x:((l=(c=(a=e.satellite)==null?void 0:a.source)==null?void 0:c.x)!=null?l:0)+n*Math.cos(o*Math.PI/180-Math.PI/2),y:((p=(h=(u=e.satellite)==null?void 0:u.source)==null?void 0:h.y)!=null?p:0)+n*Math.sin(o*Math.PI/180-Math.PI/2)};e.satellite.x=s.x,e.satellite.y=s.y}function $e(t){t.satellite||!t.anchor||(t.fx=null,t.fy=null,t.anchor.type===I.Hard&&(t.fx=t.anchor.x,t.fy=t.anchor.y))}function Pt(){const t=S.zoom().extent([[0,0],[this.svgElement.clientWidth,this.svgElement.clientHeight]]).scaleExtent([.1,3]).on("zoom",({transform:e})=>Dt.bind(this)(e));return this.svgSelection.call(t).call(t.transform,S.zoomIdentity.translate(this.worldTransform.x,this.worldTransform.y).scale(this.worldTransform.k)),this.svgSelection.on("dblclick.zoom",null),t}function Dt(t){if(this.selectionGroups.world.attr("transform",`translate(${t.x}, ${t.y}) scale(${t.k})`),this.worldTransform.k!=t.k){const e=[this.worldTransform.k,t.k].sort();Object.keys(this.onZoomRoutines).forEach(n=>{const o=parseFloat(n);o>e[0]&&o<e[1]&&this.onZoomRoutines[o].forEach(s=>s(t.k))})}this.worldTransform=t,this.eventStore.emit(m.EnvironmentMove,t)}function Me(t,e){if(t.transform)return Lt.bind(this)(t.transform,e,t.duration);const n=[];t.boundaries&&n.push(_t(t.boundaries)),t.nodes&&n.push(Ee(t.nodes)),Te.bind(this)(_t(n),e,t.duration,t.padding)}function _t(t){let e=t.reduce((r,i)=>Math.min(r,i.x),1/0),n=t.reduce((r,i)=>Math.min(r,i.y),1/0),o=t.reduce((r,i)=>Math.max(r,i.x+i.width),-1/0),s=t.reduce((r,i)=>Math.max(r,i.y+i.height),-1/0);return{x:e,y:n,width:o-e,height:s-n}}function Ee(t){var i,a,c,l,u,h,p;const e=S.extent(t,y=>y.x),n=S.extent(t,y=>y.y),o=((i=e[1])!=null?i:0)-((a=e[0])!=null?a:0),s=((c=n[1])!=null?c:0)-((l=n[0])!=null?l:0),r=(u=S.max(t.map(y=>{var f,v;return y.shape.scale*((v=(f=y.shape.template)==null?void 0:f.shapeSize)!=null?v:300)})))!=null?u:0;return{x:((h=e[0])!=null?h:0)-r/2,y:((p=n[0])!=null?p:0)-r/2,width:o+r,height:s+r}}function Lt(t,e,n){const o=this.svgElement.clientWidth,s=this.svgElement.clientHeight,r={x:o/2,y:s/2},i={x:-t.x+o/2*(1-t.k)*(t.x/(o/2))+r.x,y:-t.y+s/2*(1-t.k)*(t.y/(s/2))+r.y,k:t.k};Pe.bind(this)(i,e,n)}function Te(t,e,n,o){const s=this.svgElement.clientWidth,r=this.svgElement.clientHeight,i=s/r,a=(t.width+(o!=null?o:0)*2)/(t.height+(o!=null?o:0)*2),c=i<a?s/(t.width+(o!=null?o:0)*2):r/(t.height+(o!=null?o:0)*2),l={x:t.x+t.width/2,y:t.y+t.height/2,k:c};Lt.bind(this)(l,e,n)}function Pe(t,e,n){isNaN(t.x)||isNaN(t.y)||isNaN(t.k)||this.selectionGroups.world.transition().duration(n!=null?n:1e3).ease(S.easePolyInOut).attr("transform",`translate(${t.x},${t.y}) scale(${t.k})`).on("end",()=>{e(t)})}function De(){const t=[],e=[];return this.graph.nodes.forEach(n=>{var s,r,i,a,c,l,u,h;const o={id:n.id,x:n.x,y:n.y,shape:{type:n.shape.type,scale:n.shape.scale,url:n.shape.url},gravity:n.gravity,anchor:{type:((s=n.anchor)==null?void 0:s.type)||"",x:((r=n.anchor)==null?void 0:r.x)||0,y:((i=n.anchor)==null?void 0:i.y)||0},satellite:{source:typeof((a=n.satellite)==null?void 0:a.source)=="string"?n.satellite.source:((l=(c=n.satellite)==null?void 0:c.source)==null?void 0:l.id)||"",angle:((u=n.satellite)==null?void 0:u.angle)||0,distance:((h=n.satellite)==null?void 0:h.distance)||0},payload:n.payload};t.push(o)}),this.graph.links.forEach(n=>{const o={source:typeof n.source=="string"?n.source:n.source.id,target:typeof n.target=="string"?n.target:n.target.id,id:n.id,type:n.type,directed:n.directed,label:n.label,strength:n.strength,padding:n.padding,width:n.width,curvature:n.curvature,payload:n.payload};e.push(o)}),{nodes:t,links:e}}const Ae="";class _e{constructor(e){b(this,"debug",{enabled:!1,bodyPoints:{enabled:!0,color:"#00ffff"}});b(this,"_svgElement");b(this,"_svgSelection");b(this,"_simulation");b(this,"_selectedNodes",[]);b(this,"_zoom");b(this,"worldTransform",{x:0,y:0,k:1});b(this,"_onZoomRegister",[]);b(this,"_onZoomRoutines",{});b(this,"animationDuration",300);b(this,"draggableNodes",!0);b(this,"selectionGroups");b(this,"graph",{nodes:[],links:[]});b(this,"templateStore",new Kt);b(this,"nodeDataStore",new Ut);b(this,"eventStore",new xt);e instanceof SVGElement?(this._svgElement=e,this._svgSelection=S.select(e)):(this._svgSelection=e,this._svgElement=e.node()),this.worldTransform={x:this.svgElement.clientWidth/2,y:this.svgElement.clientHeight/2,k:1},this._simulation=this.createSimulation(),this.selectionGroups=this.createWorld(),this._zoom=Pt.bind(this)(),this.setEvents()}get svgElement(){return this._svgElement}set svgElement(e){this._svgElement=e,this._svgSelection=S.select(e),this.selectionGroups=this.createWorld(),this._zoom=Pt.bind(this)(),this.setEvents(),this.render(this.graph)}get svgSelection(){return this._svgSelection}get simulation(){return this._simulation}get selectedNodes(){return this._selectedNodes}set selectedNodes(e){this._selectedNodes=e,this.selectNodes()}get worldBounds(){const{x:e,y:n,k:o}=this.worldTransform;return{x:-(e/o),y:-(n/o),width:this.svgElement.clientWidth/o,height:this.svgElement.clientHeight/o}}set zoomScaleExtent(e){this._zoom.scaleExtent(e)}set zoomEnabled(e){this._zoom.on("zoom",null),e&&this._zoom.on("zoom",({transform:n})=>Dt.bind(this)(n))}get onZoomRegister(){return this._onZoomRegister}get onZoomRoutines(){return this._onZoomRoutines}set envGravity(e){this.simulation.force("gravity",Tt(e))}set linkDistance(e){this.simulation.force("link",Et(e))}createSimulation(){return S.forceSimulation().force("link",Et(400)).force("forceX",me()).force("forceY",xe()).force("gravity",Tt(-1e4)).force("shapeCollide",be.bind(this)).on("tick",we.bind(this)).on("end",()=>{this.eventStore.emit(m.SimulationTickEnd)})}createWorld(){const e=this.svgSelection.append("g").attr("data-object","world"),n=e.append("g").attr("data-object","links"),o=e.append("g").attr("data-object","nodes");return{world:e,nodes:o,links:n}}setEvents(){function e(n){return{x:this.worldBounds.x+n.offsetX/this.worldTransform.k,y:this.worldBounds.y+n.offsetY/this.worldTransform.k}}this.svgSelection.on("click",n=>this.eventStore.emit(m.EnvironmentClick,n,e.bind(this)(n))),this.svgSelection.on("dblclick",n=>this.eventStore.emit(m.EnvironmentDoubleClick,n,e.bind(this)(n))),this.svgSelection.on("contextmenu",n=>this.eventStore.emit(m.EnvironmentContextMenu,n,e.bind(this)(n)))}registerOnZoom(e,n,o){this.deregisterOnZoom(e),this._onZoomRegister.push({id:e,threshold:n,callback:o}),this.createOnZoomRoutines()}deregisterOnZoom(e){this._onZoomRegister=this._onZoomRegister.filter(({id:n})=>n!==e)}createOnZoomRoutines(){this._onZoomRoutines={},this._onZoomRegister.forEach(e=>{this._onZoomRoutines[e.threshold]||(this._onZoomRoutines[e.threshold]=[]),this._onZoomRoutines[e.threshold].push(e.callback)})}selectNodes(){this.selectionGroups.nodes.selectAll(".gly-selectable").classed("gly-selected",!1),this.selectionGroups.nodes.selectAll("[data-object='node']").filter(e=>this.selectedNodes.includes(e.id)).selectAll(".gly-selectable").classed("gly-selected",!0)}async render(e,n=.05,o=!1){o&&(this.nodeDataStore.clear(),this.selectionGroups.nodes.selectAll("*").remove(),this.selectionGroups.links.selectAll("*").remove()),this.graph=e,await ae.bind(this)(this.graph).then(()=>{ie(e),ce.bind(this)(this.graph),this.simulation.nodes(this.graph.nodes),this.simulation.force("link").links(e.links),this.simulation.alphaTarget(n).restart(),setTimeout(()=>{this.simulation.alphaTarget(0)},100),this._onZoomRegister.forEach(s=>s.callback(this.worldTransform.k)),this.selectNodes()})}exportGraph(){return De.bind(this)()}moveTo(e){Me.bind(this)(e,n=>{this.svgSelection.call(this._zoom.transform,S.zoomIdentity.translate(n.x,n.y).scale(n.k))})}on(e,n){this.eventStore.on(e,n)}}k.AnchorType=I,k.Event=m,k.ForceSimulation=_e,k.LinkStrength=H,k.LinkType=M,k.TemplateAPI=st,Object.defineProperties(k,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
